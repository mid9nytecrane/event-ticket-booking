<!DOCTYPE html>
<html lang="en" class='scroll-smooth duration-400'>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Booking</title>

    <!--tailwindcss cdn-->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!--flowbite cdn-->
    <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
    <!--daisy ui-->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
     <!--htmx cdn-->
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.8/dist/htmx.min.js" integrity="sha384-/TgkGk7p307TH7EXJDuUlgG3Ce1UVolAOFopFekQkkXihi5u/6OCvVKyz1W+idaz" crossorigin="anonymous"></script>
    <!--alpinejs cdn-->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.1/dist/cdn.min.js"></script>
    <!--flatpickr-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>


    <style>
        @import url('https://fonts.googleapis.com/css2?family=Boldonse&family=Fira+Code:wght@300..700&family=Gidole&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Roboto:ital,wght@0,100..900;1,100..900&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap');

        body{
            font-family: Poppins;
        }
    </style>
</head>
<body 
    x-data="{
        navbarOpen:false, 
        scrollFromTop: false,

        }" 
    x-init="console.log(window.pageYOffset > 60 ? scrollFromTop = true : scrollFromTop = false)"
    @scroll.window="console.log(window.pageYOffset > 60 ? scrollFromTop = true : scrollFromTop = false)"
    :class="{
        'overflow-hidden': navbarOpen,
        'overflow-auto': ! navbarOpen,
    }"
    >

    {% include "core/partials/navbar.html" %}
    
    {% block content %}
    
    {% endblock content %}

    {% include "core/partials/footer.html" %}

    
    <script src="/path/to/htmx.min.js"></script>
     <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>

    
        
     <script>
        document.body.addEventListener("htmx:configRequest", (event) => {
            event.detail.headers["X-CSRF-Token"] = "{{ csrf_token}}"
        });
     </script>

     {% comment %} <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.substring(0, name.length + 1) === (name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie("csrftoken");
        </script> {% endcomment %}


     <!-- HMTL5 qrcode scanner-->
      <script src="https://unpkg.com/html5-qrcode"></script>

     <script>
        document.addEventListener("DOMContentLoaded", function () {

            const resultBox = document.getElementById("resultBox");
            let lastScanned = null;
            let cooldown = false;

            function showMessage(type, text) {
                resultBox.className = "mt-4 p-4 rounded-xl border shadow";
                
                if (type === "success") {
                    resultBox.classList.add("bg-green-50","border-green-300","text-green-700");
                } else if (type === "warning") {
                    resultBox.classList.add("bg-yellow-50","border-yellow-300","text-yellow-700");
                } else {
                    resultBox.classList.add("bg-red-50","border-red-300","text-red-700");
                }

                resultBox.innerHTML = text;
            }

            async function verifyTicket(ticketCode) {
                try {
                    const response = await fetch(`/booking-event/verify-ticket-by-scan/?ticket_id=${ticketCode}`);

                    if (!response.ok) {
                        showMessage("error", "Something went wrong verifying ticket.");
                        return;
                    }

                    const data = await response.json();

                    // Handle Results
                    if (data.valid && data.status === "success") {
                        showMessage("success", `
                            <strong>Check-in Successful!</strong><br>
                            Event: ${data.event}<br>
                            Attendee: ${data.attendee}
                        `);
                    } 
                    else if (data.status === "already") {
                        showMessage("warning", `
                            <strong>Already Checked In!</strong><br>
                            ${data.message}
                        `);
                    }
                    else if (data.status === "unathorized") {
                        showMessage("error", `<strong>Unauthorized!</strong> Ticket not for your event.`);
                    }
                    else if (data.status === "inactive") {
                        showMessage("error", `<strong>Event Not Active!</strong> Ticket is not valid for today.`);
                    }
                    else {
                        showMessage("error", `<strong>Invalid Ticket!</strong> Ticket not found.`);
                    }

                } catch (err) {
                    console.error(err);
                    showMessage("error", "Network error. Try again.");
                }
            }

            function onScanSuccess(decodedText) {

                // Prevent spam scanning same code
                if (cooldown || decodedText === lastScanned) return;
                lastScanned = decodedText;
                cooldown = true;

                verifyTicket(decodedText);

                setTimeout(() => cooldown = false, 2000);
            }

            function onScanError(error) {
                console.warn(error);
            }

            // QR Scanner
            const qrScanner = new Html5QrcodeScanner("qr-reader", {
                fps: 10,
                qrbox: 250,
                rememberLastUsedCamera: true,
            });

            qrScanner.render(onScanSuccess, onScanError);
        });
        </script>



    
      {% comment %} <script>
        document.addEventListener("DOMContentLoaded", function () {
            const resultBox = document.getElementById("resultBox");
            const verifyUrl = "{% url 'booking:verify-ticket' %}";
            let scanning = false;

            // Get CSRF token from cookies
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');

            function showMessage(type, message) {
                resultBox.classList.remove("hidden");
                resultBox.classList.remove("border-red-400", "border-green-400", "border-yellow-400",
                                        "bg-red-50", "bg-green-50", "bg-yellow-50",
                                        "text-red-700", "text-green-700", "text-yellow-700");

                if (type === "success") {
                    resultBox.classList.add("border-green-400", "bg-green-50", "text-green-700");
                } else if (type === "warning") {
                    resultBox.classList.add("border-yellow-400", "bg-yellow-50", "text-yellow-700");
                } else {
                    resultBox.classList.add("border-red-400", "bg-red-50", "text-red-700");
                }

                resultBox.innerHTML = message;
            }

            const qrScanner = new Html5Qrcode("qr-reader");

            function onScanSuccess(decodedText) {
                if (scanning) return;
                scanning = true;
                
                // Clean the scanned text - remove whitespace, newlines, etc.
                //let cleanedTicketId = decodedText.trim();
                
                // Extract UUID from the scanned text (if it contains other data)
                // Common patterns for UUIDs
                //const uuidPattern = /[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i;
                //const match = cleanedTicketId.match(uuidPattern);
                
                //if (match) {
                    //cleanedTicketId = match[0];
                //} else {
                    // If not a UUID pattern, try to clean it further
                    //cleanedTicketId = cleanedTicketId.replace(/[^a-f0-9-]/gi, '');
                //}
                
                //console.log("Original scanned:", decodedText);
                //console.log("Cleaned ticket ID:", cleanedTicketId);
                
                //if (!cleanedTicketId) {
                //    showMessage("error", `<strong>Invalid QR Code ‚ùå</strong><br>No valid ticket ID found in QR code`);
                  // scanning = false;
                   // return;

                //}
                
                // Show scanning indicator
                showMessage("info", `<strong>Scanning...</strong><br>Processing QR code...`);

                // Use POST method with FormData (simpler and works with Django CSRF)
                const formData = new FormData();
                formData.append('ticket_id', decodedText);
                formData.append('csrfmiddlewaretoken', csrftoken);

                // Or use GET with query parameter (simpler for scanning)
                fetch(`${verifyUrl}?ticket_id=${encodeURIComponent(decodedText)}`, {
                    method: "GET",
                    headers: {
                        "Accept": "application/json",
                        "X-Requested-With": "XMLHttpRequest"
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Response data:", data); // For debugging
                    
                    if (data.valid === true) {
                        showMessage("success", `
                            <strong>Ticket Verified üéâ</strong><br>
                            <div class="mt-2 p-2 bg-white/50 rounded-lg">
                                <p class="text-sm"><span class="font-medium">Event:</span> ${data.event}</p>
                                <p class="text-sm"><span class="font-medium">Attendee:</span> ${data.attendee}</p>
                                <p class="text-sm"><span class="font-medium">Ticket ID:</span> ${data.ticket_id}</p>
                                <p class="text-xs opacity-70 mt-1">Checked in at: ${data.time}</p>
                            </div>
                        `);
                    }
                    else if (data.status === "already") {
                        showMessage("warning", `
                            <strong>Already Checked In ‚ö†Ô∏è</strong><br>
                            <div class="mt-2 p-2 bg-white/50 rounded-lg">
                                <p class="text-sm"><span class="font-medium">Event:</span> ${data.event}</p>
                                <p class="text-sm"><span class="font-medium">Attendee:</span> ${data.attendee}</p>
                                <p class="text-xs opacity-70">This ticket was already checked in</p>
                            </div>
                        `);
                    }
                    else {
                        showMessage("error", `
                            <strong>Invalid Ticket ‚ùå</strong><br>
                            <div class="mt-2">
                                <p>${data.message || "Ticket not found or invalid"}</p>
                                ${data.event_date ? `<p class="text-xs mt-1">Event date: ${data.event_date}</p>` : ''}
                            </div>
                        `);
                    }
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                    showMessage("error", `
                        <strong>Error ‚ùå</strong><br>
                        <p>Something went wrong, please try again</p>
                        <p class="text-xs mt-1">${error.message}</p>
                    `);
                })
                .finally(() => {
                    setTimeout(() => {
                        scanning = false; // allow next scan after 1.5 seconds
                    }, 1500);
                });
            }

            function startScanner() {
                Html5Qrcode.getCameras().then(devices => {
                    if (devices && devices.length) {
                        // Try to auto-select rear / back camera on phones
                        let backCamera = devices.find(d => 
                            d.label.toLowerCase().includes("back") || 
                            d.label.toLowerCase().includes("rear")
                        );

                        let cameraId = backCamera ? backCamera.id : devices[0].id;

                        qrScanner.start(
                            cameraId,
                            { 
                                fps: 10, 
                                qrbox: 250,
                                aspectRatio: 1.0
                            },
                            onScanSuccess,
                            (errorMessage) => {
                                // Optional: Show scan error
                                console.log("Scan error:", errorMessage);
                            }
                        ).then(() => {
                            console.log("QR Scanner started successfully");
                        }).catch(err => {
                            console.error("Failed to start scanner:", err);
                            showMessage("error", "Failed to start camera. Please check permissions.");
                        });
                    }
                }).catch(err => {
                    console.error("Camera access error:", err);
                    showMessage("error", "Camera access denied or not available");
                });
            }

            // Start scanner
            startScanner();

            // Optional: Add stop scanner function for when switching modes
            function stopScanner() {
                qrScanner.stop().then(() => {
                    console.log("QR Scanner stopped");
                }).catch(err => {
                    console.error("Failed to stop scanner:", err);
                });
            }

            // Optional: Clean up on page unload
            window.addEventListener('beforeunload', function() {
                stopScanner();
            });

        });
    </script>
       {% endcomment %}

    {% comment %} <script>
    document.addEventListener("DOMContentLoaded", function () {
        const resultBox = document.getElementById("resultBox");
        const verifyUrl = "{% url 'booking:verify-ticket' %}";
        let scanning = false;

        function showMessage(type, message) {
            resultBox.classList.remove("hidden");
            resultBox.classList.remove("border-red-400", "border-green-400", "border-yellow-400",
                                    "bg-red-50", "bg-green-50", "bg-yellow-50",
                                    "text-red-700", "text-green-700", "text-yellow-700");

            if (type === "success") {
                resultBox.classList.add("border-green-400", "bg-green-50", "text-green-700");
            } else if (type === "warning") {
                resultBox.classList.add("border-yellow-400", "bg-yellow-50", "text-yellow-700");
            } else {
                resultBox.classList.add("border-red-400", "bg-red-50", "text-red-700");
            }

            resultBox.innerHTML = message;
        }

        const qrScanner = new Html5Qrcode("qr-reader");

        function onScanSuccess(decodedText) {
            if (scanning) return;
            scanning = true;

            fetch(`${verifyUrl}?ticket_id=${decodedText}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "X-CRSFToken": csrftoken
                },
                body: JSON.stringify({
                    ticket_id:decodedText   
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.valid) {
                    showMessage("success", `
                        <strong>Ticket Verified üéâ</strong><br>
                        Event: ${data.event}<br>
                        Attendee: ${data.attendee}
                    `);
                }
                else if (data.status === "already") {
                    showMessage("warning", `
                        <strong>Already Checked In ‚ö†Ô∏è</strong><br>
                        Event: ${data.event}<br>
                        Attendee: ${data.attendee}
                    `);
                }
                else {
                    showMessage("error", `<strong>Invalid Ticket ‚ùå</strong><br> Ticket not found`);
                }
            })
            .catch(() => {
                showMessage("error", "Something went wrong, please try again");
            })
            .finally(() => {
                setTimeout(() => {
                    scanning = false; // allow next scan
                }, 1500);
            });
        }

        Html5Qrcode.getCameras().then(devices => {
            if (devices && devices.length) {

                // Try to auto-select rear / back camera on phones
                let backCamera = devices.find(d => 
                    d.label.toLowerCase().includes("back") || 
                    d.label.toLowerCase().includes("rear")
                );

                let cameraId = backCamera ? backCamera.id : devices[0].id;

                qrScanner.start(
                    cameraId,
                    { fps: 10, qrbox: 250 },
                    onScanSuccess
                );
            }
        }).catch(err => {
            console.error(err);
            showMessage("error", "Camera access denied or not available");
        });


    });
    </script>  {% endcomment %}


    
</body>
</html>